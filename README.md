# RL Antiyoy Game 
# Участники
- Богданов Ярослав
- Ильин Павел
- Тураянов Денис
- Шаяхметов Аскар

# Инструкция по запуску
### Запуск API и инструментов

В файле `default.env` указан порт API-сервера и число воркеров:

EXTERNAL_PORT=<адрес сервера>\
GUNICORN_WORKERS=<число воркеров>

Запуск:

```bash
docker-compose -f docker-compose.yml --env-file default.env up --build
```

### Запуск игрового сервера

В файле `default.env` указан порт игрового сервера:

EXTERNAL_PORT_GAMESERVER=<адрес игрового сервера>\
GUNICORN_WORKERS=<число воркеров>

Запуск:

```bash
docker compose -f docker-compose.gameserver.yml --env-file default.env up --build
```

### Демо (иногда работает)
- [Проигрыватель логов с записью игры mcst](http://gameapi.afsh.space/log_player/demo/)
- [Редактор gamestate](http://gameapi.afsh.space/state_editor/)
- [Игровой сервер](http://antiyoygame.afsh.space/)


# Описание структуры

Есть два сервиса 

- **game-interface**: Stateless-сервис для обучения AI. Предоставляет три ручки:  
  - `generate_state` — генерация начального состояния игры,  
  - `get_actions` — получение легальных ходов для переданного состояния,  
  - `apply_action` — применение переданного хода к переданному состоянию и возврат нового состояния.  
- **game-server**: Stateful игровой сервер. Реализует API, WebSockets и функциональность лобби и игровых комнат, где игроки могут создавать комнаты, собирать участников и запускать игры.
## Корневой каталог
- **dataset.md**: Собранные игры
- **default.env**: Файл конфигурации для настройки портов и числа процессов сервисов
- **docker-compose.yml**: docker-compose для game-interface
- **docker-compose.gameserver.yml**: docker-compose для game-server
- **Dockerfile**: Dockerfile для контейнера game-interface
- **Dockerfile.gameserver**: Dockerfile контейнера игрового сервера.
- **gunicorn_config.py**: конфиг для запуска игрового сервера
- **requirements.txt**: зависимости для game-interface
- **requirements-gameserver.txt**: зависимости для игрового сервера
- **requirements-dev.txt**: зависимости для github actions


## Каталоги

### `nginx/`

Конфигурационные файлы для nginx

- **default.conf**: конфигурация для game-interface
- **gameserver.conf**: Конфигурация Nginx, специфичная для game-server.


### `src/`

Основной каталог исходного кода

#### `src/ai/`

- **collect_bootstrap_data.py**: Скрипт для сбора игр mcts против mcts.
- **dqn_imp.py**: Реализация dqn.
- **hex_dqn_masked.pth**: веса dqn
- **mcts.py**: Реализация алгоритма Monte Carlo Tree Search (MCTS)

#### `src/game/`

Основная игровая логика.

- **gamecontroller.py**: управление игровой логикой, обработка, верификация действий игроков, обновление игрового состояния
- `core/`:
  - **const.py**: Константы, для отрисовки field
  - **field.py**: Реализация логики игрового поля, на шестиугольной сетке: генерация карты, применение ходов, учет доходов, территорий.
  - **tile.py**: Свойства отдельного тайла на поле

#### `src/game_interface/`

Апи для обучения. Реализует три ручки: 
1) generate_state генерирует исходный стейт
2) get_actions для переданного стейта возвращает легальные ходы
3) apply_action для переданного стейта применяет переданный ход и возвращает новый стейт

- **app.py**: Основная логика приложения для игрового интерфейса (например, приложение на Flask или FastAPI).
- **models.py**: Модели данных для запросов и ответов
- **utils.py**: Применение игровой логики

#### `src/server/`

Игровой сервер.

- **app.py**: Основное серверное приложение на FastAPI
- **config.py**: Настройки конфигурации сервера.
- `handlers/`:
  - **api.py**: Обработчики API-эндпоинтов для сервера.
  - **websockets.py**: Обработчики WebSocket для игры в реальном времени
- `models/`:
  - **managers.py**: управление WebSocket-соединениями для лобби и игровых комнат: подключение, отключение, рассылка сообщений, логирование, мониторинг.
  - **room.py**: управление комнатой: добавление удаление игроков, отслеживание готовности, запуск игры.
- `monitoring/`:
  - **logging_config.py**: Конфиг для логирования приложения.
  - **metrics.py**: Определение prometheus метрик приложения.
- `services/`:
  - **game_service.py**: управление комнатами: отслеживание их состояния, создание, удаление.

#### `src/utils/`
- **all_turns_ever.py**: нумерация всех возможных ходов для одной из карт.

### `web/`

Фронтенд

- `static/`:
  - `images/`:
    - **.png**: картинки юнитов, зданий
  - `js/`:
    - **compiled/**: Скомпилированные js файлы
    - **gamepage.ts**: Логика странички с игрой
    - **main.ts**: Логика лобби
  - `maps/`:
    - **map_basic_10x10.json**: небольшая карта
    - **map_basic_small.json**: карта еще меньше
  - `misc/`:
    - **demo_log.jsonl**: демо лог для {apibase}/log_player/demo
- `templates/`:
  - **gamepage.html**: HTML-шаблон для игровой страницы.
  - **log_player.html**: HTML-шаблон для проигрывателя логов
  - **newlobby.html**: HTML-шаблон для лобби
  - **state_editor.html**: HTML-шаблон редактора стейтов.
- **tsconfig.json**: конфиг ts



### Описание данных

Логи игры хранятся в лог-файлах. Каждый ход — это одна строка с JSON-объектом `gamestate`.

Описание структуры объекта находится здесь:

http://gameapi.afsh.space/docs

# Правила игры

## Основы
- Карта состоит из гексагональных ячеек.
- У каждого игрока есть база из 8 соединённых ячеек, одна из которых — ратуша.
- Начальный запас: 100 монет.
- Доход за ход = количество захваченных ячеек + бонусы от ферм.
- Захват ячеек: юнит перемещается на нейтральную/вражескую ячейку в радиусе доступности (4), если она не заблокирована башней либо вражеским юнитом.

## Здания
- **Ферма**:
  - Стоимость: 12 + 2 × [число уже купленных ферм игрока].
  - Доход: +4 монеты/ход.
  - Условие: ставится в радиусе 1 от ратуши или другой фермы на своей ячейке.
- **Слабая башня**:
  - Стоимость: 15 монет, обслуживание: 1/ход.
  - Эффект: блокирует юнитов < 3 уровня в радиусе 1 (только на своих ячейках).
- **Сильная башня**:
  - Стоимость: 35 монет, обслуживание: 6/ход.
  - Эффект: блокирует юнитов < 4 уровня в радиусе 1 (только на своих ячейках).
- Примечание: здания не исчезают при отрицательном балансе монет.

## Юниты
- Уровни и стоимость:
  - Уровень 1: 10 монет, обслуживание 2/ход.
  - Уровень 2: 20 монет, обслуживание 4/ход.
  - Уровень 3: 30 монет, обслуживание 12/ход.
  - Уровень 4: 40 монет, обслуживание 18/ход.
- Защита: юнит уровня N блокирует юнитов уровня ≤ N в радиусе 1 (только на своих ячейках) (кроме 4 против 4).
- Перемещение: радиус 4 по своим ячейкам. Нейтральные/вражеские ячейки доступны для захвата, но ветка обрезается. Защищённые ячейки недоступны.
- Первый ход: только покупка, без обслуживания.
- Склеивание:
  - Уровень = min(4, сумма уровней).
  - Второй юнит должен быть в радиусе 4 от первого.
  - Итоговый юнит стоит на месте второго и может ходить снова.

## Механика хода
- Покупка зданий и юнитов в пределах доступных монет.
- Юнит ходит 1 раз за ход (радиус 4). Склеивание считается ходом.
- Если монеты уходят в минус из-за обслуживания, все юниты исчезают, запас = 0.

## Ратуша
- Если враг встаёт на ратушу, она перемещается в случайную дружественную ячейку.
- База — это 8 захваченных ячеек, ратуша — одна из них.

## Условия игры
- Проигрыш: потеря всех ячеек.
- Победа: уничтожение всех ячеек противника.

---

# Пример первого хода

## Условия
- База: 8 ячеек.
- Монеты: 100.
- Цель: экономика + лёгкая экспансия.

## Действия
1. **Доход**: 8 ячеек = 8 монет/ход.
2. **Покупки**:
   - **2 фермы**:
     - Первая: 12 монет (+4 доход).
     - Вторая: 14 монет (12 + 2 × 1) (+4 доход).
     - Итого: 26 монет, доход = 8 + 4 + 4 = 16 монет/ход.
     - Ставим рядом с ратушей.
   - **Слабая башня**: 15 монет, обслуживание 1/ход. Ставим у ратуши.
   - **Юнит 2 уровня**: 20 монет, обслуживание 4/ход. Ставим на краю базы.
3. **Расходы**: 26 + 15 + 20 = 61 монета.
4. **Остаток**: 100 - 61 = 39 монет.
5. **Перемещение**:
   - Юнит 2 уровня идёт на 4 ячейки и захватывает нейтральную ячейку.
   - Итог: 9 ячеек.

## Итог
- 9 ячеек, 2 фермы, 1 слабая башня, 1 юнит 2 уровня.
- Монеты: 39.
- Следующий ход: доход 17 (9 + 8), расходы 5 (4 + 1), прибыль +12, итого 51 монета.
